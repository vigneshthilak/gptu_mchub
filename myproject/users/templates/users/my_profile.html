{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTU MC Hub-My Profile</title>

    <!-- The link for the Bootstrap -->

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- The link for the Bootstrap -->
    
    <!-- The link for the CSS Stylesheet -->
    
        <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- The link for the CSS Stylesheet -->

    <!-- The link for the favicon -->

        <link rel="shortcut icon" type="image/png" href="{% static 'images/GPTU Logo.png' %}">

    <!-- The link for the favicon -->

    <!-- The link for the font (Google Fonts) used in the web page -->

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,400;0,600;0,700;1,200&display=swap" rel="stylesheet">

    <!-- The link for the font (Google Fonts) used in the web page-->

    <!-- The link for the font awesome to import the icons -->

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- The link for the font awesome to import the icons -->

</head>
<body>

    <!-- Navigation Bar (Menu Bar) -->

        <nav class="navbar navbar-expand-lg navbar-dark custom-navbar">
            <div class="container-fluid">
                <a class="navbar-brand" href="{% url 'users:dashboard' %}">
                    <img src="{% static 'images/logo.png' %}">
                </a>
        
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
        
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:dashboard' %}">Home</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="studentsDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Students
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="studentsDropdown">
                                <li><a class="dropdown-item" href="{% url 'users:add_stu' %}">Add Student</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'users:view_stu' %}">View Students</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'users:upload_stu' %}">Upload Students</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Profile
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:my_profile' %}">
                                        <i class="fa fa-user-circle"></i> My Profile
                                    </a>
                                </li>
                                {% if user.is_superuser %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <i class="fa fa-user-plus"></i> Add User
                                        </a>
                                    </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:logout' %}">
                                        <i class="fa fa-sign-out"></i> Log out
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
  
    <!-- Navigation Bar (Menu Bar) -->

    <section class="gptu_mchub-users-profile-pic">
        <div class="container">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="profile-container">
                    <div class="profile-info">
                        <div class="profile-image">
                            {% if not profile.profile_picture or profile.profile_picture == "" %}
                                <img id="profile-picture-display" src="/static/images/default-avatar.png" alt="Profile Picture">
                            {% else %}
                                <img id="profile-picture-display" src="{{ profile.profile_picture.url }}" alt="Profile Picture">
                            {% endif %}
                        
                        </div>
                        <div class="profile-details">
                            <p class="username"><strong>Username:</strong> {{ profile.username }}</p>
                            <p class="email"><strong>Email-ID:</strong> {{ profile.email }}</p>
                            <a href="{% url 'users:logout' %}" class="btn logout-button">Logout</a>
                        </div>
                    </div>
                    <div class="profile-upload">
                        <label for="image-upload" class="image-upload-label">Select Image</label>
                        <input type="file" id="image-upload" name="profile_picture" accept="image/*" style="display: none;">
                        <span id="selected-image-name"></span>
                        <button id="upload-button" type="submit" name="upload_picture" disabled>Upload</button>
                    </div>
                </div>
            </form>
        </div>
    </section>
    
    <section class="gptu_mchub-users-profile">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center form-title">
                <h3><strong>Edit your Profile</strong></h3>
                <button id="editBtn" class="btn edit-btn">Edit</button>
            </div>
            <div class="profile-container">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" name="first_name" class="form-control" id="firstName" value="{{ profile.first_name }}" placeholder="Enter first name" disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="last_name" class="form-control" id="lastName" value="{{ profile.last_name }}" placeholder="Enter last name" disabled>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" id="email" value="{{ profile.email }}" placeholder="Enter email" disabled>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">User ID</label>
                            <input type="text" name="user_id" class="form-control" id="userId" value="{{ profile.user_id }}" placeholder="Enter user ID" disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" id="username" value="{{ profile.username }}" placeholder="Enter username" disabled>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Department</label>
                            <select name="department" class="form-select" disabled>
                                <option value="" selected disabled>Select Department</option>
                                <option value="DCIVIL" {% if profile.department == "DCIVIL" %}selected{% endif %}>DCIVIL</option>
                                <option value="DMECH" {% if profile.department == "DMECH" %}selected{% endif %}>DMECH</option>
                                <option value="DEEE" {% if profile.department == "DEEE" %}selected{% endif %}>DEEE</option>
                                <option value="DECE" {% if profile.department == "DECE" %}selected{% endif %}>DECE</option>
                                <option value="DCSE" {% if profile.department == "DCSE" %}selected{% endif %}>DCSE</option>
                                <option value="DMX" {% if profile.department == "DMX" %}selected{% endif %}>DMX</option>
                                <option value="DMT" {% if profile.department == "DMT" %}selected{% endif %}>DMT</option>
                                <option value="OTHERS" {% if profile.department == "OTHERS" %}selected{% endif %}>OTHERS</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gender</label>
                            <select name="gender" class="form-select" disabled>
                                <option value="" selected disabled>Select Gender</option>
                                <option value="female" {% if profile.gender == "female" %}selected{% endif %}>Female</option>
                                <option value="male" {% if profile.gender == "male" %}selected{% endif %}>Male</option>
                                <option value="others" {% if profile.gender == "others" %}selected{% endif %}>Others</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" class="btn btn-success" id="saveBtn" name="update_profile" disabled>Save Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <section class="gptu_mchub-users-pass_reset">
        <div class="container">
            <h3 class="form-title">Change Password</h3>
            <div class="profile-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="form-container">
                            <div id="password-section">
                                <form class="row g-2 stack-lg" method="POST" id="passwordChangeForm">
                                    {% csrf_token %}
                                    <div class="col-12">
                                        <label class="form-label">Old Password</label>
                                        <input type="password" class="form-control" name="old_password" placeholder="Enter Old Password" required>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control" name="new_password" placeholder="Enter New Password" required>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Confirm Password</label>
                                        <input type="password" class="form-control" name="confirm_password" placeholder="Enter Confirm Password" required>
                                    </div>
                                    <!-- To Display the Error Message -->

                                        {% if messages %}
                                            {% for message in messages %}
                                                {% if 'password_form' in message.tags %}
                                                    <div class="custom-message {% if 'error' in message.tags %}error-message{% elif 'success' in message.tags %}success-message{% endif %}">
                                                        {{ message }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        
                                    <!-- To Display the Error Message -->
                                    <div class="col-12">
                                        <button type="submit" name="generate_otp" class="btn gen-otp">Generate OTP</button>
                                    </div>
                                </form>
                                <form class="row g-2 stack-lg" action="" method="post">
                                    {% csrf_token %}
                                    <!-- New input field and button in the same row -->
                                    <div class="col-8">
                                        <input type="text" id="otpInput" class="form-control otp-form" name="otp" placeholder="Enter OTP" maxlength="6">
                                    </div>
                                    <div class="col-4">
                                        <button type="submit" name="verify_otp" class="btn verify-otp w-100">Verify</button>
                                    </div>
                                </form>
                                {% if request.session.otp_sent %}
                                    <form method="post">
                                        {% csrf_token %}
                                        <button id="resendOtpButton" name="resend_otp" class="btn resend-otp">Resend OTP</button>
                                        <p class="text-center" id="timer">You can resend OTP in <span id="countdown">30</span>s</p>
                                    </form>
                                {% endif %}
                                <!-- To Display the Error Message -->

                                    {% if messages %}
                                        {% for message in messages %}
                                            {% if 'otp_form' in message.tags %}
                                                <div class="custom-message {% if 'error' in message.tags %}error-message{% elif 'success' in message.tags %}success-message{% endif %}">
                                                    {{ message }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                <!-- To Display the Error Message -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p>Please follow the below given procedure to Change your GPTU Mentor & Counselling Hub account password.</p>
                        <ol>
                            <li>Enter your old password in the <b>"Old Password"</b> field.</li>
                            <li>Enter your new password in the <b>"New Password"</b> field.</li>
                            <li>Re-Enter the same password in the <b>"Confirm Password"</b> field.</li>
                            <li>After enter your password just click the <b>"Update Password"</b> button to change the password.</li>
                            <li>If you encounter a message like <b>"Password do not match!"</b> kindly ensure the <b>"New Password"</b> and <b>"Confirm Password"</b> are same.</li>
                            <li>Otherwise you will be promted to <b>"OTP Verification"</b></li>
                            <li>The OTP is sent to your <b>"Email-ID"</b> which is registed in your GPTU MC HUB account.</li>
                            <li>After the OTP Verification your password will be changed.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer of the webpage -->

        <div class="gptu_mchub-footer">
            <div class="container">
                <h1>Govt. Polytechnic College Uthangarai</h1>
                <div class="gptu_mchub-footer-dev">
                    <hr>
                    <p>
                        © Govt Polytechnic College, Uthangarai. All Rights Reserved<br>
                        <small>Developed by GPT Uthangarai from the Department of Computer Engineering</small>
                    </p>
                </div>
            </div>
        </div>

    <!-- Footer of the webpage -->

    <!-- The Link for the Bootstrap bundle Script -->

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- The Link for the Bootstrap bundle Script -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- The Link for the Java Script file -->

        <script src="{% static 'js/script.js' %}"></script>

    <!-- The Link for the Java Script file -->
    
    <script>
        document.getElementById("editBtn").addEventListener("click", function () {
            // Enable all inputs and selects inside the form
            const formElements = document.querySelectorAll("form input, form select, form button[type='submit']");
            formElements.forEach(el => el.removeAttribute("disabled"));
        });

        const imageUpload = document.getElementById('image-upload');
        const selectedImageName = document.getElementById('selected-image-name');
        const uploadButton = document.getElementById('upload-button');
        const profilePictureDisplay = document.getElementById('profile-picture-display');

        imageUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                selectedImageName.textContent = file.name;
                uploadButton.disabled = false; // Enable the button
            
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePictureDisplay.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                selectedImageName.textContent = '';
                uploadButton.disabled = true; // Disable the button
                profilePictureDisplay.src = "{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}";
            }
        });

        document.addEventListener("DOMContentLoaded", function () { 
            let resendButton = document.getElementById("resendOtpButton");
            let countdownElement = document.getElementById("countdown");
            let timerText = document.getElementById("timer");
            let countdown = 30;
            let form = resendButton.closest("form"); // Get the form containing the button

            function updateTimer() {
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                    countdown--;
                    setTimeout(updateTimer, 1000);
                } else {
                    resendButton.disabled = false; // Enable button after countdown
                    timerText.style.display = "none";
                }
            }
        
            // Disable button initially when page loads
            resendButton.disabled = true;
            updateTimer();
        
            resendButton.addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default only to handle timer
                resendButton.disabled = true; // Disable button immediately after click
                countdown = 30;
                timerText.style.display = "block";
                updateTimer();
            
                // Submit the form manually after disabling button
                setTimeout(() => {
                    form.submit();
                }, 100); // Small delay to ensure button is disabled before form submission
            });
        });

    </script>
</body>
</html>